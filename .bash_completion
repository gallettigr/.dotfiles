#!/usr/bin/env bash

# Add Gulp completion
if [ -x "$(command -v gulp)" ]; then
  eval "$(gulp --completion=bash)"
fi

# PIP
_pip() {
  local cur prev commands opts
  cur="${COMP_WORDS[COMP_CWORD]}"
  prev="${COMP_WORDS[COMP_CWORD - 1]}"
  first="${COMP_WORDS[0]}"

  commands=$($first --help | awk '/Commands\:/,/General Options\:/' |
    \grep -E -o "^\s{2}\w+" | tr -d ' ')
  opts=$($first --help | \grep -E -o "((-\w{1}|--(\w|-)*=?)){1,2}")

  if [ $COMP_CWORD == 1 ]; then
    COMPREPLY=($(compgen -W "${commands}" -- ${cur}))
    return 0
  fi

  if [[ ${cur} == -* ]]; then
    local command_opts
    command_opts=$($first $prev --help |
      \grep -E -o "((-\w{1}|--(\w|-)*=?)){1,2}")
    COMPREPLY=($(compgen -W "${command_opts}" -- ${cur}))
    return 0
  fi
}
complete -o default -F _pip pip
complete -o default -F _pip pip2
complete -o default -F _pip pip3

# Add tab completion for SSH hostnames based on ~/.ssh/config, ignoring wildcards
_ssh_hosts() {
  COMPREPLY=""
  if [ -r "$HOME/.ssh/config" ]; then
    COMPREPLY+=($(grep "^Host" $HOME/.ssh/config | grep -v "[?*]" | cut -d " " -f2 | tr ' ' '\n'))
  fi
  if [ -r "$HOME/.ssh/known_hosts" ]; then
    COMPREPLY+=($(grep -E -o "(([0-9]{1,3}\.){3}[0-9]{1,3})" $HOME/.ssh/known_hosts))
    COMPREPLY+=($(grep -E -o "((?:[a-zA-Z0-9_-]+\.)*[a-zA-Z0-9][a-zA-Z0-9_-]+\.[a-zA-Z]+)" $HOME/.ssh/known_hosts))
  fi
}
complete -o "default" -o "nospace" -F _ssh_hosts scp sftp ssh

# Add Git-Number alias and completion
if [ -x "$(command -v git-number)" ]; then
  # Set aliases
  alias gs="git-number"
  alias ga="gs add"
  alias gc="gs -c git commit"
  alias gd="gs -c git diff --ignore-space-at-eol --ignore-all-space --ignore-space-change --ignore-blank-lines"
  alias gr="gs -c git reset"
  alias gl="gs -c git log -w -b -p --ignore-blank-lines"
  alias gco="gs -c git checkout"

  # Completion for aliases
  if type _git &>/dev/null && [ -f /usr/local/etc/bash_completion.d/git-completion.bash ]; then
    __git_complete gs _git
    __git_complete ga _git_add
    __git_complete gc _git_commit
    __git_complete gd _git_diff
    __git_complete gr _git_reset
    __git_complete gl _git_log
    __git_complete gco _git_checkout
  fi
fi
